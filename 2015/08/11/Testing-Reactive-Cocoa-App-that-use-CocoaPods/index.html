<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Testing a Reactive Cocoa App that use CocoaPods &middot; Code Craftsman
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="/public/css/custom.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>This is my personal blog where I talk about software.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
      
        
      
    
      
        
      
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
      
    
      
        
          <a class="sidebar-nav-item" href="/posts/">All posts</a>
        
      
    

    <span class="sidebar-nav-item">Currently v1.0.0</span>
  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2015. All rights reserved.
    </p>
  </div>
    <div class="infos">
    <span>
      <a href="https://twitter.com/liquidseb" target="_blank"><i class="fa fa-twitter"></i></a>
    </span>
    <span>
      <a href="https://github.com/liquidsoul" target="_blank"><i class="fa fa-github"></i></a>
    </span>
    <span>
      <a href="https://fr.linkedin.com/in/sebastienduperron" target="_blank"><i class="fa fa-linkedin-square"></i></a>
    </span>
    <span>
      <a href="mailto:contact@code-craftsman.fr?subject=Contact from code-craftsman.fr" target="_blank"><i class="fa fa-envelope"></i></a>
    </span>
  </div>

</div>


    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">Code Craftsman</a>
            <small>Software craftsmanship and iOS development</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
  <h1 class="post-title">Testing a Reactive Cocoa App that use CocoaPods</h1>
  <span class="post-date">11 Aug 2015</span>
  <p>Last weekend, I stumbled across something while trying to learn MVVM.</p>

<p>I was playing with the <a href="http://www.raywenderlich.com/74106/mvvm-tutorial-with-reactivecocoa-part-1">Colin Eberhardt’s tutorial</a> which explains how to set up the pattern using ReactiveCocoa. As I was progressing through the <a href="http://www.raywenderlich.com/74131/mvvm-tutorial-with-reactivecocoa-part-2">second part</a>, I saw this note:<br />
<code>If you’re feeling adventurous, prove it by writing a unit test that executes a search and navigates from one ViewModel to the next</code></p>

<p>Because I wanted to be able to set up more tests by using MVVM, I decided that I felt adventurous enough to test the ViewModels without any UI.</p>

<h2 id="well-put-their-name-to-the-test">‘We’ll put their name to the test’</h2>

<p>So I tried to set up a first basic test:</p>

<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">testPerformSearch</span>
<span class="p">{</span>
	<span class="n">XCTestExpectation</span> <span class="o">*</span><span class="n">expectation</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">expectationWithDescription</span><span class="p">:</span><span class="s">@&quot;Search success&quot;</span><span class="p">];</span>

	<span class="kt">id</span><span class="o">&lt;</span><span class="n">RWTViewModelServices</span><span class="o">&gt;</span> <span class="n">viewModelServices</span> <span class="o">=</span> <span class="p">[[</span><span class="n">MockService</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithPushBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span> <span class="n">viewModel</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">expectation</span> <span class="n">fulfill</span><span class="p">];</span>
	<span class="p">}];</span>
	<span class="n">RWTFlickrSearchViewModel</span> <span class="o">*</span><span class="n">viewModel</span> <span class="o">=</span> <span class="p">[[</span><span class="n">RWTFlickrSearchViewModel</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithServices</span><span class="p">:</span><span class="n">viewModelServices</span><span class="p">];</span>

	<span class="n">viewModel</span><span class="p">.</span><span class="n">searchText</span> <span class="o">=</span> <span class="s">@&quot;beach&quot;</span><span class="p">;</span>
	<span class="p">[</span><span class="n">viewModel</span><span class="p">.</span><span class="n">executeSearch</span> <span class="nl">execute</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>

	<span class="p">[</span><span class="nb">self</span> <span class="nl">waitForExpectationsWithTimeout</span><span class="p">:</span><span class="mi">2</span> <span class="nl">handler</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span></code></pre></div>

<p>Because I was using some ReactiveCocoa here, it was necessary to import the ReactiveCocoa header to make this work. To do this, I just applied the same pod configuration to my test target:</p>

<p><img src="public/images/RAC_Issue/TestConfigurationFile.png" alt="Test configuration file" /></p>

<p>Once my test compiled, I was quite confident that it would pass. However, here is what I got:</p>

<div class="highlight"><pre><code class="language-objective-c" data-lang="objective-c"><span class="nl">error</span><span class="p">:</span> <span class="o">-</span><span class="p">[</span><span class="n">ReactiveCocoaTestIssueTests</span> <span class="n">testExecute</span><span class="p">]</span> <span class="o">:</span> <span class="nl">failed</span><span class="p">:</span> <span class="n">caught</span> <span class="s">&quot;NSInternalInconsistencyException&quot;</span><span class="p">,</span> <span class="s">&quot;-and must only be used on a signal of RACTuples of NSNumbers. Instead, received: &lt;RACTuple: 0x7fdd8bd40af0&gt; (</span>
    <span class="mi">0</span><span class="p">,</span>
    <span class="mi">1</span>
<span class="p">)</span><span class="s">&quot;</span></code></pre></div>

<p>This was weird… a <code>RACTuple</code> that is not a <code>RACTuple</code>…</p>

<p>After some time digging, I found <a href="https://github.com/ReactiveCocoa/ReactiveCocoa/issues/901">this isssue</a> in ReactiveCocoa github.</p>

<p>One explaination might be that we have more than only one <code>RACTuple</code> class.</p>

<p>It appears that this is related to some setup issues with CocoaPods that does not operate well with the default test setup of Xcode.<br />
By default, tests are run against the Host Application (see your Project &gt; Targets &gt; General)</p>

<p><img src="public/images/RAC_Issue/TestingDefaultSetup.jpg" alt="Testing target image" /></p>

<p>and linking the test target to ReactiveCocoa <em>doubles</em> the symbols because Xcode perform some dynamic code injection behind the scene.</p>

<h2 id="getting-out-of-the-pit">Getting out of the pit</h2>

<p>There are multiple solutions to this, but, unfortunately, nothing straightforward which use CocoaPods. As I discovered, I am not the first one to stumble upon <a href="https://github.com/CocoaPods/CocoaPods/issues/1411">this</a> and the feature is still <a href="https://github.com/CocoaPods/CocoaPods/issues/840">missing</a>.</p>

<p>So what can one do ?</p>

<ul>
  <li>One solution is to change your testing settings and stop testing against the Application. In this case, you need to compile all the code you want to test in your test target. This can be quite cumbersome because every time you add a class in your App, you may need to add it to your test target. Another problem is that you run your tests outside the context of your running App, this can be problematic in some cases.</li>
  <li>Another quicker solution I found was to add the Pods headers folder to the Test target’s header path recursively: <code>$(PROJECT_DIR)/Pods/Headers</code>. This is kind of dirty, but that do the trick.</li>
  <li>Last, but not least, setting up your project/workspace entirely by yourself is, of course, a viable solution. I am still new to CocoaPods, and as I see its immediate value<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>, I am also wondering if relying on it in the long run might have some annoying downsides. I have been a long time user of git submodules. So you could still do this because you won’t relying of some generated settings on your project.</li>
</ul>

<p>Maybe there are other solutions but, for now, I have just used the second one for my problem.</p>

<p>If you want to see an example of the problem, I shared <a href="https://github.com/Liquidsoul/ReactiveCocoaTestIssue">a project on github</a>.</p>

<p>I hope this will help someone!</p>
<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>injecting third-party libraries like if it was nothing <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

</div>


<div class="related">
  <h2>Previous posts</h2>
  <ul class="related-posts">
    
      
    
      
      <li>
        <h3>
          <a href="/2015/08/04/saving-core-data-objects/">
            Saving CoreData objects
            <small>04 Aug 2015</small>
            <p><small>The associated playground can be found in this repo! The context I am quite new at using Core Data. I have started to use it…</small></p>
          </a>
        </h3>
      </li>
      
    
      
      <li>
        <h3>
          <a href="/2015/07/30/my-very-first-post/">
            My very first post
            <small>30 Jul 2015</small>
            <p><small>Hi!

This is my first blog post ever and, hopefully, it will be the first of many to come.
</small></p>
          </a>
        </h3>
      </li>
      
    
  </ul>
</div>


      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-65955194-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>
</html>
